@{
    ViewData["Title"] = "Jury";
    var state = Contest.GetState();
    var problems = await Contest.Context.ListProblemsAsync();
}

@functions {
    static string PassingTime(DateTimeOffset? start, TimeSpan? end)
    {
        return end.HasValue && start.HasValue ? (start + end).Value.ToString()
            : end.HasValue ? "+" + end.Value.ToString()
            : "-";
    }
}

<div class="mt-2 mb-2">
    <h1 class="mt-0 d-inline mb-0 mr-1">
        Contest <span>@Contest.ShortName</span>
    </h1>
    <a asp-action="Edit" class="btn btn-outline-primary btn-sm"><i class="fas fa-edit"></i> Edit</a>
    <a asp-action="Description" class="btn btn-outline-info btn-sm"><i class="fab fa-markdown"></i> Description</a>
</div>

<h4 class="text-left mb-3">@Contest.Name</h4>

<style>
    .other-table td { padding: 4px 2px 2px 4px; }
</style>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                Time
            </div>
            <div class="card-body">
                <form method="post">
                    <table class="table table-hover mb-0">
                        <tbody>
                            <tr>
                                <td class="align-middle"><i class="fas fa-@(state >= ContestState.Started ? "check" : "")"></i></td>
                                <td class="align-middle"><b>Start time:</b></td>
                                <td class="align-middle">@(Contest.StartTime?.ToString() ?? "not scheduled")</td>
                                <td class="align-middle">
                                    <button asp-show-if="state == ContestState.ScheduledToStart" asp-action="ChangeState" asp-route-target="startnow" class="btn btn-sm btn-primary">start now</button>
                                    <button asp-show-if="state == ContestState.ScheduledToStart" asp-action="ChangeState" asp-route-target="delay" class="mt-1 mt-md-0 btn btn-sm btn-primary">delay</button>
                                    <button asp-show-if="state == ContestState.NotScheduled" asp-action="ChangeState" asp-route-target="startnow" class="btn btn-sm btn-primary">start now</button>
                                </td>
                            </tr>
                            <tr>
                                <td class="align-middle"><i class="fas fa-@(Contest.FreezeTime.HasValue && state >= ContestState.Frozen ? "check" : "")"></i></td>
                                <td class="align-middle"><b>Freeze time:</b></td>
                                <td class="align-middle">@PassingTime(Contest.StartTime, Contest.FreezeTime)</td>
                                <td class="align-middle"><button asp-show-if="state == ContestState.Started" asp-action="ChangeState" asp-route-target="freeze" class="btn btn-sm btn-primary">freeze now</button></td>
                            </tr>
                            <tr>
                                <td class="align-middle"><i asp-show-if="Contest.EndTime.HasValue && state >= ContestState.Ended" class="fas fa-check"></i></td>
                                <td class="align-middle"><b>End time:</b></td>
                                <td class="align-middle">@PassingTime(Contest.StartTime, Contest.EndTime)</td>
                                <td class="align-middle"><button asp-show-if="state == ContestState.Started || state == ContestState.Frozen" asp-action="ChangeState" asp-route-target="endnow" class="btn btn-sm btn-primary">end now</button></td>
                            </tr>
                            <tr>
                                <td class="align-middle"><i class="fas fa-@(Contest.UnfreezeTime.HasValue && state >= ContestState.Finalized ? "check" : "")"></i></td>
                                <td class="align-middle"><b>Unfreeze time:</b></td>
                                <td class="align-middle">@PassingTime(Contest.StartTime, Contest.UnfreezeTime)</td>
                                <td class="align-middle"><button asp-show-if="state == ContestState.Ended" asp-action="ChangeState" asp-route-target="unfreeze" class="btn btn-sm btn-primary">unfreeze now</button></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header">
                Utilities
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <h5 class="ml-2 text-left">Infrastructures</h5>
                        <ul>
                            <li><a asp-area="Dashboard" asp-controller="Executables" asp-action="List">Executables</a></li>
                            <li><a asp-area="Dashboard" asp-controller="Judgehosts" asp-action="List">Judgehosts</a></li>
                            <li><a asp-area="Dashboard" asp-controller="InternalErrors" asp-action="List">Internal Errors</a></li>
                            <li><a asp-controller="JuryProblems" asp-action="List">Problems</a></li>
                            <li><a asp-area="Dashboard" asp-controller="Languages" asp-action="List">Languages</a></li>
                            <li><a asp-controller="JuryTeams" asp-action="List">Teams</a></li>
                            <li><a asp-area="Dashboard" asp-controller="Categories" asp-action="List">Team Categories</a></li>
                            <li><a asp-controller="JuryAffiliations" asp-action="List">Team Affiliations</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-6">
                        <h5 class="ml-2 text-left">During contest</h5>
                        <ul>
                            <li asp-show-if="Contest.Settings.BalloonAvailable"><a asp-controller="JuryBalloons" asp-action="List">Balloon status</a></li>
                            <li asp-show-if="Contest.Settings.PrintingAvailable"><a asp-controller="JuryPrintings" asp-action="List">Printing status</a></li>
                            <li asp-show-if="Contest.Settings.PrintingAvailable"><a asp-action="Print">Print</a></li>
                            <li><a asp-controller="JuryRejudgings" asp-action="List">Rejudgings</a></li>
                            <li><a asp-controller="JuryAnalysis" asp-action="Overview">Statistics/Analysis</a></li>
                            <!--<li><a asp-action="ResetEventFeed" data-target="refresh" data-toggle="ajaxWindow">Reset event feed</a></li>-->
                            <li><a asp-action="RefreshCache" data-target="refresh" data-toggle="ajaxWindow">Refresh scoreboard cache</a></li>
                            <li><a asp-controller="JuryProblems" asp-action="GenerateStatement">Statement TeX</a></li>
                            <li><a asp-action="Auditlog">Audit log</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card mb-3">
            <div class="card-header">
                Problems
            </div>
            <div class="card-body">
                <table class="table data-table table-sm table-striped table-hover mb-0 d-lg-table other-table">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">name</th>
                            <th scope="col">submit?</th>
                            <th scope="col">judge?</th>
                            <th></th>
                            <th><a class="text-reset" asp-controller="JuryProblems" asp-action="Add" data-toggle="ajaxWindow" data-target="addProb"><i class="fas fa-plus"></i></a></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var prob in problems)
                        {
                            <tr asp-controller="JuryProblems" asp-action="Detail" asp-route-probid="@prob.ProblemId" data-toggle="gotoUrl">
                                <td use-a>p@(prob.ProblemId)</td>
                                <td use-a><div class="circle" style="background-color: @prob.Color"></div> <span class="text-monospace">@prob.ShortName</span> - @prob.Title</td>
                                <td use-a>@(prob.AllowSubmit ? "Yes" : "No")</td>
                                <td use-a>@(prob.AllowJudge ? "Yes" : "No")</td>
                                <td><a asp-controller="JuryProblems" asp-action="Edit" asp-route-probid="@prob.ProblemId" data-toggle="ajaxWindow" data-target="editProb"><i class="fas fa-edit"></i></a></td>
                                <td><a asp-controller="JuryProblems" asp-action="Delete" asp-route-probid="@prob.ProblemId" data-toggle="ajaxWindow" data-target="deleteProb"><i class="fas fa-trash-alt"></i></a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header">
                Jury members
            </div>
            <div class="card-body">
                <table class="table data-table table-sm table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">User Name</th>
                            <th><a asp-in-roles="Administrator" class="text-reset" asp-action="Assign" data-toggle="ajaxWindow" data-target="assign"><i class="fas fa-plus"></i></a></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var u in await Contest.Context.ListJuriesAsync())
                        {
                            <tr asp-area="Account" asp-controller="Profile" asp-action="Show" asp-route-username="@u.Value" data-toggle="gotoUrl">
                                <td use-a>u@(u.Key)</td>
                                <td use-a>@u.Value</td>
                                <td><a asp-in-roles="Administrator" asp-action="Unassign" asp-route-userid="@u.Key" data-toggle="ajaxWindow" data-target="unassign"><i class="fas fa-trash-alt"></i></a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
